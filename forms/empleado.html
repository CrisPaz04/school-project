<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Empleados - Sistema Escolar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/styles.css">
</head>

<body>
    <div class="container">
        <header class="d-flex justify-content-between align-items-center py-3 mb-4 border-bottom">
            <h1 class="h4">Gestión de Empleados</h1>
            <div>
                <a href="../index.html" class="btn btn-outline-secondary">Volver al Menú</a>
                <button class="btn btn-outline-danger ms-2" onclick="logout()">Cerrar Sesión</button>
            </div>
        </header>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Formulario de Empleado</h5>
                    </div>
                    <div class="card-body">
                        <form id="empleadoForm">
                            <input type="hidden" id="empleadoId" value="">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="nombre" class="form-label">Nombre</label>
                                    <input type="text" class="form-control" id="nombre" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="apellido" class="form-label">Apellido</label>
                                    <input type="text" class="form-control" id="apellido" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="fechaNacimiento" class="form-label">Fecha de Nacimiento</label>
                                    <input type="date" class="form-control" id="fechaNacimiento" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="fechaContratacion" class="form-label">Fecha de Contratación</label>
                                    <input type="date" class="form-control" id="fechaContratacion" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="telefono" class="form-label">Teléfono</label>
                                    <input type="tel" class="form-control" id="telefono" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="correo" class="form-label">Correo Electrónico</label>
                                    <input type="email" class="form-control" id="correo" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="direccion" class="form-label">Dirección</label>
                                    <input type="text" class="form-control" id="direccion" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="salario" class="form-label">Salario</label>
                                    <input type="number" class="form-control" id="salario" min="0" step="0.01" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="esProfesor">
                                    <label class="form-check-label" for="esProfesor">
                                        Es Profesor
                                    </label>
                                </div>
                            </div>
                            <div id="datosProfesor" style="display: none;">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="especialidad" class="form-label">Especialidad</label>
                                        <input type="text" class="form-control" id="especialidad">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="nivelAcademico" class="form-label">Nivel Académico</label>
                                        <select class="form-select" id="nivelAcademico">
                                            <option value="">Seleccione un nivel</option>
                                            <option value="Licenciatura">Licenciatura</option>
                                            <option value="Maestría">Maestría</option>
                                            <option value="Doctorado">Doctorado</option>
                                            <option value="Postdoctorado">Postdoctorado</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="anosExperiencia" class="form-label">Años de Experiencia</label>
                                    <input type="number" class="form-control" id="anosExperiencia" min="0">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-success" id="btnGuardar"
                                    onclick="handleGuardar()">Guardar</button>
                                <button type="button" class="btn btn-info" id="btnConsultar">Consultar</button>
                                <button type="reset" class="btn btn-secondary">Limpiar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Listado de Empleados</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Apellido</th>
                                        <th>Teléfono</th>
                                        <th>Correo</th>
                                        <th>Fecha Contratación</th>
                                        <th>Salario</th>
                                        <th>Es Profesor</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaEmpleados">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/login.js"></script>
    <script src="../js/empleado.js"></script>

    <script>
        function handleGuardar() {
            const id = document.getElementById('empleadoId').value;
            console.log("ID del empleado en handleGuardar:", id);

            if (id && id !== "") {
                console.log("Ejecutando actualización");
                // Es una actualización - SOLO actualizamos
                const empleado = {
                    nombre: document.getElementById("nombre").value,
                    apellido: document.getElementById("apellido").value,
                    fecha_nacimiento: document.getElementById("fechaNacimiento").value,
                    fecha_contratacion: document.getElementById("fechaContratacion").value,
                    telefono: document.getElementById("telefono").value,
                    correo: document.getElementById("correo").value,
                    direccion: document.getElementById("direccion").value,
                    salario: document.getElementById("salario").value
                };

                // Hacer la petición PUT para actualizar
                fetch(`../api/empleado.php?id=${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(empleado)
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Verificar si es profesor
                            const esProfesorCheckbox = document.getElementById("esProfesor");
                            const esProfesor = esProfesorCheckbox && esProfesorCheckbox.checked;

                            // Verificar si el empleado ya es profesor (hacer petición GET)
                            return fetch(`../api/profesor.php?withEmpleadoInfo=${id}`)
                                .then(response => response.json())
                                .then(profesorData => {
                                    const eraProfesor = Array.isArray(profesorData) && profesorData.length > 0;

                                    // Si es profesor y no era profesor, crear nuevo registro de profesor
                                    if (esProfesor && !eraProfesor) {
                                        const profesor = {
                                            ID_empleado: id,
                                            especialidad: document.getElementById("especialidad")?.value || "",
                                            nivel_academico: document.getElementById("nivelAcademico")?.value || "",
                                            anos_experiencia: document.getElementById("anosExperiencia")?.value || ""
                                        };

                                        return fetch(`../api/profesor.php`, {
                                            method: "POST",
                                            headers: {
                                                "Content-Type": "application/json"
                                            },
                                            body: JSON.stringify(profesor)
                                        });
                                    }
                                    // Si es profesor y ya era profesor, actualizar registro existente
                                    else if (esProfesor && eraProfesor) {
                                        const profesor = {
                                            especialidad: document.getElementById("especialidad")?.value || "",
                                            nivel_academico: document.getElementById("nivelAcademico")?.value || "",
                                            anos_experiencia: document.getElementById("anosExperiencia")?.value || ""
                                        };

                                        return fetch(`../api/profesor.php?id=${id}`, {
                                            method: "PUT",
                                            headers: {
                                                "Content-Type": "application/json"
                                            },
                                            body: JSON.stringify(profesor)
                                        });
                                    }
                                    // Si no es profesor pero era profesor, eliminar registro de profesor
                                    else if (!esProfesor && eraProfesor) {
                                        return fetch(`../api/profesor.php?id=${id}`, {
                                            method: "DELETE"
                                        });
                                    }

                                    return { ok: true };
                                })
                                .then(response => {
                                    if (!response.ok && response.json) {
                                        return response.json().then(err => { throw err; });
                                    }

                                    alert("Empleado actualizado con éxito");
                                    document.getElementById("empleadoForm").reset();
                                    document.getElementById("empleadoId").value = "";
                                    location.reload();
                                    return; // Asegurarse de que nada más se ejecute
                                });
                        } else {
                            throw new Error(data.error || "Error desconocido");
                        }
                    })
                    .catch(error => {
                        console.error("Error al actualizar empleado:", error);
                        alert(`Error al actualizar empleado: ${error.message || error}`);
                    });
            } else {
                console.log("Ejecutando creación");
                // Es un nuevo registro
                const empleado = {
                    nombre: document.getElementById("nombre").value,
                    apellido: document.getElementById("apellido").value,
                    fecha_nacimiento: document.getElementById("fechaNacimiento").value,
                    fecha_contratacion: document.getElementById("fechaContratacion").value,
                    telefono: document.getElementById("telefono").value,
                    correo: document.getElementById("correo").value,
                    direccion: document.getElementById("direccion").value,
                    salario: document.getElementById("salario").value
                };

                fetch("../api/empleado.php", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(empleado)
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Verificar si es profesor
                            const esProfesorCheckbox = document.getElementById("esProfesor");
                            const esProfesor = esProfesorCheckbox && esProfesorCheckbox.checked;

                            if (esProfesor) {
                                const profesor = {
                                    ID_empleado: data.id,
                                    especialidad: document.getElementById("especialidad")?.value || "",
                                    nivel_academico: document.getElementById("nivelAcademico")?.value || "",
                                    anos_experiencia: document.getElementById("anosExperiencia")?.value || ""
                                };

                                return fetch(`../api/profesor.php`, {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json"
                                    },
                                    body: JSON.stringify(profesor)
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            return response.json().then(err => { throw err; });
                                        }
                                        return response.json();
                                    })
                                    .then(profesorData => {
                                        alert("Empleado y profesor creados con éxito");
                                        document.getElementById("empleadoForm").reset();
                                        location.reload();
                                    });
                            } else {
                                alert("Empleado creado con éxito");
                                document.getElementById("empleadoForm").reset();
                                location.reload();
                            }
                        } else {
                            throw new Error(data.error || "Error desconocido");
                        }
                    })
                    .catch(error => {
                        console.error("Error al crear empleado:", error);
                        alert(`Error al crear empleado: ${error.message || error}`);
                    });
            }

            // Prevenir que el evento se propague o que se ejecuten otras funciones
            return false;
        }
    </script>

</body>

</html>